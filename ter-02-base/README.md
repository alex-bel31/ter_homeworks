# –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –∫ –∑–∞–Ω—è—Ç–∏—é ¬´–û—Å–Ω–æ–≤—ã Terraform. Yandex Cloud¬ª

## –ó–∞–¥–∞–Ω–∏–µ 1

–û—à–∏–±–∫–∞ –≤ –∑–Ω–∞—á–µ–Ω–∏–∏ –∞—Ç—Ä–∏–±—É—Ç–∞ platform_id. –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã standart-v4 –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.

```ps1
platform_id = "standart-v4"
```

–£–∫–∞–∑–∞–Ω–∞ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–∞—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ–ª—è vCPU –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ ¬´standard-v3¬ª, –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Ñ—Ä–∞–∫—Ü–∏–∏ —è–¥—Ä–∞: 20, 50, 100.
–£–∫–∞–∑–∞–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —è–¥–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ ¬´standard-v3¬ª, –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —è–¥–µ—Ä: 2 –¥–æ 96

- –û—Ç–≤–µ—Ç—å—Ç–µ, –∫–∞–∫ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±—É—á–µ–Ω–∏—è –º–æ–≥—É—Ç –ø—Ä–∏–≥–æ–¥–∏—Ç—å—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã preemptible = true –∏ core_fraction=5 –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö –í–ú
    - –°–∏–ª—å–Ω–æ –¥–µ—à–µ–≤–ª–µ –æ–±—ã—á–Ω—ã—Ö –í–ú.

## –ó–∞–¥–∞–Ω–∏–µ 2 

```s
data "yandex_compute_image" "ubuntu" {
  family = var.vm_web_image_family
}
resource "yandex_compute_instance" "platform" {
  name        = var.vm_web_name
  platform_id = var.vm_web_platform_id
  resources {
    cores         = var.vm_web_cores
    memory        = var.vm_web_memory
    core_fraction = var.vm_web_core_fraction
  }
```

*–∫–∞—Ä—Ç–∏–Ω–∫–∞ terraform plan*

## –ó–∞–¥–∞–Ω–∏–µ 3 

–ü–µ—Ä–º–µ–Ω–Ω—ã–µ –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ –í–ú –±—ã–ª–∏ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ —Ñ–∞–π–ª **vms_platform.tf**.
–°–æ–∑–¥–∞–Ω—ã –¥–≤–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö –≤ —Ä–∞–∑–Ω—ã—Ö –∑–æ–Ω–∞—Ö:
- web_platform —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö vm_web_*
- db_platform —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∏–∑ vm_db_*

*–∫–∞—Ä—Ç–∏–Ω–∫–∞ yc-t3*

## –ó–∞–¥–∞–Ω–∏–µ 4 

–ë—ã–ª —Å–æ–∑–¥–∞–Ω –±–ª–æ–∫ `output "instances_info"` —Å–æ–¥–µ—Ä–∂–∞—â–∏–π: instance_name, external_ip, fqdn –¥–ª—è –∫–∞–∂–¥–æ–π –∏–∑ –í–ú.
–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö –¥–ª—è `instances_info` - **map(map())**, –≥–¥–µ –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –í–ú –∏ –µ—ë –∞—Ç—Ä–∏–±—É—Ç—ã.

## –ó–∞–¥–∞–Ω–∏–µ 5

–í –±–ª–æ–∫–µ `locals` —Å–æ–∑–¥–∞–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `vm_web_name` –∏ v`m_db_name` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏ –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `var.vm_name`.


```s
locals {
  vm_web_name = "netology-develop-platform-${var.vm_name[0]}"
  vm_db_name  = "netology-develop-platform-${var.vm_name[1]}"
}
```
## –ó–∞–¥–∞–Ω–∏–µ 6

–ó–∞–¥–∞–ª –ø–µ—Ä–º–µ–Ω–Ω—É—é `vms_resources` –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π `map(object)`, –≥–¥–µ –∫–ª—é—á–∞–º–∏ —è–≤–ª—è—é—Ç—Å—è –∏–º–µ–Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω, –∞ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –æ–±—ä–µ–∫—Ç—ã —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –í–ú.

```s
variable "vms_resources" {
  type = map(object({
    cores         = number
    memory        = number
    core_fraction = number
  }))
  default = {
    vm_web = {
      cores         = 2
      memory        = 1
      core_fraction = 20
    }
    vm_db = {
      cores         = 2
      memory        = 2
      core_fraction = 20
    }
  }
  description = "Defines resource configuration for VM"
}
```

–°–æ–∑–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `vms_metadata` —Ç–∏–ø–∞ **map(string)** —Å –¥–≤—É–º—è –∫–ª—é—á–∞–º–∏: `"serial-port-enable"` –∏ `"ssh-keys"`.

```c
variable "vms_metadata" {
  type = map(string)
  default = {
    "serial-port-enable" = "1"
    "ssh-keys"           = "ubuntu:ssh-ed25519 xxxxxxx"
  }
  sensitive = true
}
```

## –ó–∞–¥–∞–Ω–∏–µ 7*


–í –∫–∞—á–µ—Å—Ç–≤–µ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏ –∏—Ö –≤—ã–≤–æ–¥.

> length(local.test_list)
> local.test_map["admin"]
> values(local.test_map)
>"${local.test_map["admin"]} is ${keys(local.test_map)[0]} for ${local.test_list[2]} server based on OS ${local.servers["stage"].image} with ${local.servers["stage"].cpu} vcpu, ${local.servers["stage"].ram} ${keys(local.servers["stage"])[3]} and ${length(local.servers["stage"].disks)} virtual disks"
"John is admin for production server based on OS ubuntu-20-04 with 4 vcpu, 8 ram and 2 virtual disks"

*–∫–∞—Ä—Ç–∏–Ω–∫–∞ t7*

## –ó–∞–¥–∞–Ω–∏–µ 8
–¢–∏–ø –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –±—ã–ª –∑–∞–¥–∞–Ω –∫–∞–∫:
```py
type = list(map(list(string)))
```
–≤—ã—Ä–∞–∂–µ–Ω–∏–µ –≤ terraform console, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–∑–≤–æ–ª–∏—Ç –≤—ã—á–ª–µ–Ω–∏—Ç—å —Å—Ç—Ä–æ–∫—É "ssh -o 'StrictHostKeyChecking=no' ubuntu@62.84.124.117" –≤—ã–≥–ª—è–¥–∏—Ç —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

> var.test[0].dev1[0]
"ssh -o 'StrictHostKeyChecking=no' ubuntu@62.84.124.117"

## –ó–∞–¥–∞–Ω–∏–µ 9

–í–æ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –≤—ã—Ö–æ–¥–∞ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω –≤ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –ø–æ–¥—Å–µ—Ç—è—Ö —á–µ—Ä–µ–∑ NAT-—à–ª—é–∑ –≤ Yandex Cloud:

---

## üìÑ –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã

### 1. üîß –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–¥—Å–µ—Ç–µ–π

–†–∞–Ω–µ–µ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã –¥–≤–µ –ø–æ–¥—Å–µ—Ç–∏ –≤ VPC-—Å–µ—Ç–∏ `develop`:

- `web_develop` ‚Äî –≤ –∑–æ–Ω–µ `${var.vm_web_zone}`
- `db_develop` ‚Äî –≤ –∑–æ–Ω–µ `${var.vm_db_zone}`

–í –∫–∞–∂–¥—É—é –∏–∑ –Ω–∏—Ö –±—ã–ª–∞ **–¥–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞**:

```hcl
route_table_id = yandex_vpc_route_table.rt.id
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–¥—Å–µ—Ç—è–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ —Å –º–∞—Ä—à—Ä—É—Ç–æ–º —á–µ—Ä–µ–∑ NAT-—à–ª—é–∑, —á—Ç–æ–±—ã –º–∞—à–∏–Ω—ã –∏–∑ —ç—Ç–∏—Ö –ø–æ–¥—Å–µ—Ç–µ–π –º–æ–≥–ª–∏ –≤—ã—Ö–æ–¥–∏—Ç—å –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.

---

### 2. üåê –°–æ–∑–¥–∞–Ω–∏–µ NAT-—à–ª—é–∑–∞

–ë—ã–ª —Å–æ–∑–¥–∞–Ω —Ä–µ—Å—É—Ä—Å:

```hcl
resource "yandex_vpc_gateway" "nat_gateway"
```

–° –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `shared_egress_gateway {}` ‚Äî —ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ —à–ª—é–∑ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –æ–±—â–µ–≥–æ –∏—Å—Ö–æ–¥—è—â–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ –∏–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø–æ–¥—Å–µ—Ç–µ–π.

---

### 3. üß≠ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏

–°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ `yandex_vpc_route_table.rt`, –≤ –∫–æ—Ç–æ—Ä—É—é –¥–æ–±–∞–≤–ª–µ–Ω –º–∞—Ä—à—Ä—É—Ç:

```hcl
static_route {
  destination_prefix = "0.0.0.0/0"
  gateway_id         = yandex_vpc_gateway.nat_gateway.id
}
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç: –≤–µ—Å—å –≤–Ω–µ—à–Ω–∏–π —Ç—Ä–∞—Ñ–∏–∫ (–≤–µ—Å—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç) –¥–æ–ª–∂–µ–Ω –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ NAT-—à–ª—é–∑.

---

### 4. üßë‚Äçüíª –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –í–ú –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞

–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –±—ã–ª–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º –º–∞—à–∏–Ω–∞–º —á–µ—Ä–µ–∑ `ssh`, –ø–æ—Å–ª–µ —á–µ–≥–æ:

- –ë—ã–ª **–∑–∞–¥–∞–Ω –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é**
- –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤—Ö–æ–¥–∞ –≤ –í–ú —á–µ—Ä–µ–∑ **—Å–µ—Ä–∏–π–Ω—É—é –∫–æ–Ω—Å–æ–ª—å** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ SSH-–¥–æ—Å—Ç—É–ø–∞)

---

### 5. üì∏ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø—É–±–ª–∏—á–Ω—ã—Ö IP –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞

- –ë—ã–ª —Å–¥–µ–ª–∞–Ω **—Å–∫—Ä–∏–Ω—à–æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –í–ú**, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –≤–∏–¥–Ω–æ, —á—Ç–æ:
  - –£ –º–∞—à–∏–Ω **–Ω–µ—Ç –ø—É–±–ª–∏—á–Ω—ã—Ö IP-–∞–¥—Ä–µ—Å–æ–≤**
  - –ü–∏–Ω–≥ –¥–æ `ya.ru` **—É—Å–ø–µ—à–µ–Ω**, —á—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –≤—ã—Ö–æ–¥ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —á–µ—Ä–µ–∑ NAT-—à–ª—é–∑

  *2 –∫–∞—Ä—Ç–∏–Ω–∫–∏ t9*